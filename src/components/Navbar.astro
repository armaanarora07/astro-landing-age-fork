---
import { Github, LinkedinIcon, Menu, X, Sun, Moon, Facebook, Instagram } from 'lucide-react';
import XLogo from './XLogo.astro';
import Image from './Image.astro';
import { config } from '../config';

const currentPath = Astro.url.pathname;
const isHomePage = currentPath === '/';
const prefix = isHomePage ? '' : '/';
const companyName = config.app.name;
const { twitter, github, linkedin, facebook, instagram } = config.social;
const hasSocialLinks = twitter || github || linkedin || facebook || instagram;
---

<nav class="fixed w-full z-50 transition-all duration-300 py-6" id="navbar">
  <div class="max-w-7xl mx-auto px-6 flex items-center justify-between h-full">
    <a href={prefix} class="flex items-center space-x-1 text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300">
      <div class="flex items-center gap-2">
        <Image src="/images/icon/logo.png" alt="Company Logo" width={32} height={32} class="w-8 h-8" />
        <span class="text-xl font-semibold">{companyName}</span>
      </div>
    </a>
    
    <div class="flex items-center space-x-8">
      <button 
        id="theme-toggle"
        class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
        aria-label="Toggle theme"
      >
        <Sun className="w-5 h-5 hidden dark:block" />
        <Moon className="w-5 h-5 block dark:hidden" />
      </button>
      
      <button 
        id="menu-toggle"
        class="md:hidden p-2 rounded-lg text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
        aria-label="Toggle menu"
      >
        <Menu className="w-6 h-6" id="menu-icon" />
        <X className="hidden w-6 h-6" id="close-icon" />
      </button>
      
      <div class="hidden md:flex items-center space-x-8">
        <a href="#benefits" class="text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300">Benefits</a>
        <a href="#pricing" class="text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300">Pricing</a>
        <a href="#faq" class="text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300">FAQ</a>
        {hasSocialLinks && <div class="h-4 w-px bg-gray-200 dark:bg-gray-700"></div>}
        {hasSocialLinks && (
        <div class="flex items-center space-x-4">
            {twitter && (
          <a 
                href={twitter}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
            aria-label="Twitter Profile"
          >
            <XLogo className="w-4 h-4" />
          </a>
            )}
            {linkedin && (
          <a 
                href={linkedin}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
            aria-label="LinkedIn Profile"
          >
            <LinkedinIcon className="w-4 h-4" />
          </a>
            )}
            {github && (
          <a 
                href={github}
            target="_blank"
            rel="noopener noreferrer"
            class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
            aria-label="GitHub Profile"
          >
            <Github className="w-4 h-4" />
          </a>
            )}
            {facebook && (
              <a 
                href={facebook}
                target="_blank"
                rel="noopener noreferrer"
                class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                aria-label="Facebook Profile"
              >
                <Facebook className="w-4 h-4" />
              </a>
            )}
            {instagram && (
              <a 
                href={instagram}
                target="_blank"
                rel="noopener noreferrer"
                class="p-2 rounded-full text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                aria-label="Instagram Profile"
              >
                <Instagram className="w-4 h-4" />
              </a>
            )}
        </div>
        )}
      </div>
    </div>
  </div>
  
  <!-- Mobile menu - Using inline styles for reliability -->
  <div 
    id="mobile-menu"
    style="
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100vh; 
      background-color: rgba(255, 255, 255, 1);
      z-index: 9999;
      overflow-y: auto;
      padding-top: 80px;
    "
  >
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: -1;
    " id="menu-backdrop"></div>
    
    <div style="
      position: relative;
      z-index: 10;
      padding: 0 20px;
    ">
      <div style="
        display: flex;
        flex-direction: column;
        gap: 20px;
      ">
        <a 
          href="#benefits" 
          style="font-size: 24px; font-weight: 500; color: rgb(17, 24, 39);"
          class="dark-mobile-link"
        >
          Benefits
        </a>
        <a 
          href="#pricing" 
          style="font-size: 24px; font-weight: 500; color: rgb(17, 24, 39);"
          class="dark-mobile-link"
        >
          Pricing
        </a>
        <a 
          href="#faq" 
          style="font-size: 24px; font-weight: 500; color: rgb(17, 24, 39);"
          class="dark-mobile-link"
        >
          FAQ
        </a>
        
        {hasSocialLinks && (
        <div style="
          display: flex;
          gap: 16px;
          padding-top: 20px;
        ">
          {twitter && (
          <a 
            href={twitter}
            target="_blank"
            rel="noopener noreferrer"
            style="color: rgb(17, 24, 39);"
            class="dark-mobile-link"
            aria-label="Twitter Profile"
          >
            <XLogo className="w-6 h-6" />
          </a>
          )}
          {linkedin && (
          <a 
            href={linkedin}
            target="_blank"
            rel="noopener noreferrer"
            style="color: rgb(17, 24, 39);"
            class="dark-mobile-link"
            aria-label="LinkedIn Profile"
          >
            <LinkedinIcon className="w-6 h-6" />
          </a>
          )}
          {github && (
          <a 
            href={github}
            target="_blank"
            rel="noopener noreferrer"
            style="color: rgb(17, 24, 39);"
            class="dark-mobile-link"
            aria-label="GitHub Profile"
          >
            <Github className="w-6 h-6" />
          </a>
          )}
          {facebook && (
          <a 
            href={facebook}
            target="_blank"
            rel="noopener noreferrer"
            style="color: rgb(17, 24, 39);"
            class="dark-mobile-link"
            aria-label="Facebook Profile"
          >
            <Facebook className="w-6 h-6" />
          </a>
          )}
          {instagram && (
          <a 
            href={instagram}
            target="_blank"
            rel="noopener noreferrer"
            style="color: rgb(17, 24, 39);"
            class="dark-mobile-link"
            aria-label="Instagram Profile"
          >
            <Instagram className="w-6 h-6" />
          </a>
          )}
        </div>
        )}
      </div>
    </div>
    <button
      id="close-mobile-menu"
      style="
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 8px;
        color: rgb(17, 24, 39);
        z-index: 20;
      "
      class="dark-mobile-link"
      aria-label="Close menu"
    >
      <X className="w-6 h-6" />
    </button>
  </div>
</nav>

<script>
  function setupThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    if (!themeToggle) return;

    const toggleTheme = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update mobile menu colors for dark mode
      updateMobileMenuColors(isDark);
      
      window.dispatchEvent(new Event('themeChange'));
    };

    // Remove existing event listeners if any
    const newThemeToggle = themeToggle.cloneNode(true) as HTMLElement;
    if (themeToggle.parentNode) {
      themeToggle.parentNode.replaceChild(newThemeToggle, themeToggle);
    }
    
    // Add new event listener
    newThemeToggle.addEventListener('click', toggleTheme);
    
    // Set initial dark mode state
    const isDarkMode = document.documentElement.classList.contains('dark');
    updateMobileMenuColors(isDarkMode);
  }
  
  function updateMobileMenuColors(isDark: boolean) {
    // Update the mobile menu backdrop color
    const menuBackdrop = document.getElementById('menu-backdrop');
    if (menuBackdrop) {
      menuBackdrop.style.backgroundColor = isDark ? 'rgb(17, 24, 39)' : 'white';
    }
    
    // Update mobile menu text colors
    const darkLinks = document.querySelectorAll('.dark-mobile-link');
    darkLinks.forEach(link => {
      const element = link as HTMLElement;
      element.style.color = isDark ? 'white' : 'rgb(17, 24, 39)';
    });
    
    // Update the mobile menu background color
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenu) {
      mobileMenu.style.backgroundColor = isDark ? 'rgba(17, 24, 39, 1)' : 'rgba(255, 255, 255, 1)';
    }
  }

  function setupMobileMenu() {
    // Get DOM elements directly
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeButton = document.getElementById('close-mobile-menu');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');
    
    // Bail if elements don't exist
    if (!menuToggle || !mobileMenu || !closeButton || !menuIcon || !closeIcon) {
      return;
    }
    
    // Cast to HTMLElement to satisfy TypeScript
    const menu = mobileMenu as HTMLElement;
    const mIcon = menuIcon as HTMLElement;
    const cIcon = closeIcon as HTMLElement;
    const closeBtn = closeButton as HTMLElement;
    
    // Function to open menu
    function openMenu() {
      // Force the menu to be visible with inline styles
      menu.style.display = 'block';
      document.body.style.overflow = 'hidden';
      mIcon.classList.add('hidden');
      cIcon.classList.remove('hidden');
    }
    
    // Function to close menu
    function closeMenu() {
      menu.style.display = 'none';
      document.body.style.overflow = '';
      mIcon.classList.remove('hidden');
      cIcon.classList.add('hidden');
    }
    
    // Direct click handlers
    menuToggle.onclick = function() {
      openMenu();
      return false;
    };
    
    closeBtn.onclick = function() {
      closeMenu();
      return false;
    };
    
    // Close menu when clicking on links
    const menuLinks = mobileMenu.querySelectorAll('a');
    menuLinks.forEach(link => {
      link.onclick = function() {
        setTimeout(closeMenu, 100);
      };
    });
    
    // Set initial state
    closeMenu();
  }

  function setupNavbarScroll() {
    const navbar = document.getElementById('navbar');
    let scrolled = false;
    
    const handleScroll = () => {
      if (window.scrollY > 50 && !scrolled) {
        navbar?.classList.add('bg-white/80', 'dark:bg-gray-900/80', 'backdrop-blur-lg', 'shadow-sm');
        scrolled = true;
      } else if (window.scrollY <= 50 && scrolled) {
        navbar?.classList.remove('bg-white/80', 'dark:bg-gray-900/80', 'backdrop-blur-lg', 'shadow-sm');
        scrolled = false;
      }
    };

    window.removeEventListener('scroll', handleScroll);
    window.addEventListener('scroll', handleScroll);
    
    // Check initial scroll position
    handleScroll();
  }

  function setupSmoothScrolling() {
    // Get all internal links (those that start with #)
    const navLinks = document.querySelectorAll('a[href^="#"]:not([href="#"]):not(.dark-mobile-link)');
    
    navLinks.forEach(link => {
      // Clean the original event listeners
      const newLink = link.cloneNode(true) as HTMLAnchorElement;
      if (link.parentNode) {
        link.parentNode.replaceChild(newLink, link);
      }
      
      // Add smooth scrolling
      newLink.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Get the target element
        const targetId = newLink.getAttribute('href');
        if (!targetId) return;
        
        const targetElement = document.querySelector(targetId);
        if (!targetElement) return;
        
        // Account for fixed navbar with some extra padding
        const navbarHeight = document.getElementById('navbar')?.offsetHeight || 0;
        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navbarHeight - 20;
        
        // Smooth scroll to the target
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
        
        // Update the URL but don't scroll (we already did that)
        history.pushState(null, '', targetId);
      });
    });
  }

  function initializeAll() {
    setupThemeToggle();
    setupMobileMenu();
    setupNavbarScroll();
    setupSmoothScrolling();
  }

  // Run on page load
  initializeAll();

  // Rerun after navigation
  document.addEventListener('astro:page-load', initializeAll);
  window.addEventListener('hashchange', initializeAll);
</script>